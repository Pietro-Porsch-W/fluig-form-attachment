;(function($){"use strict";var b='fluigFormAttachment',c=item=>typeof item==='string',d={showActionButton:!0,filename:'Anexo',prefixName:!1,accept:'*'},e=['isValid','hasAttachment'];class Plugin{#settings;#input;#container;#attachmentFilename;constructor(a,A){this.#settings=$.extend({},d,A);this.#input=$(a);this.#attachmentFilename=this.#input.val()||this.#input.text().trim();this.#input.prop('readonly',!0).on('change',()=>{this.#attachmentFilename=this.#input.val();this.#changeButtonsState()}).wrap(`<div class="${b}Component"></div>`).after(`<div class="${b}Component_buttons">${this.#getButtonsTemplate()}</div>`);this.#container=this.#input.closest(`.${b}Component`);this.#container.on('click',`.${b}BtnDeleteFile`,()=>this.#confirmDeleteAttachment()).on('click',`.${b}BtnUpuloadFile`,()=>this.#uploadAttachment()).on('click',`.${b}BtnViewerFile`,()=>this.#viewAttachment())}isValid(){return this.#attachmentFilename.length?this.hasAttachment():!0}hasAttachment(){var _=this.#attachmentFilename||this.#input.val()||this.#input.text().trim();return _.length>0&&parent.ECM.attachmentTable.getData().findIndex(B=>B.description===_)!==-1}deleteAttachment(){var C=parent.ECM.attachmentTable.getData().findIndex(_a=>_a.description===this.#attachmentFilename);setTimeout(()=>this.#input.val('').trigger('change'),500);if(C===-1)return;parent.WKFViewAttachment.removeAttach([C])}showActionButton(){this.#settings.showActionButton=!0;this.#input.trigger('change')}hideActionButton(){this.#settings.showActionButton=!1;this.#input.trigger('change')}#getButtonsTemplate(){var D=this.#attachmentFilename.length!==0,_b=this.#canDisplayActionButton();return `<button type="button" class="${b}BtnAction ${b}BtnDeleteFile btn btn-danger btn-sm ${(_b&&D)?'':'hide'}" title="Remover Anexo"><i class="flaticon flaticon-trash icon-sm"></i></button>`+`<button type="button" class="${b}BtnAction ${b}BtnUpuloadFile btn btn-success btn-sm ${(_b&&!D)?'':'hide'}" title="Enviar Anexo"><i class="flaticon flaticon-upload icon-sm"></i></button>`+`<button type="button" class="${b}BtnViewerFile btn btn-info btn-sm ${D?'':'hide'}" title="Visualizar Anexo"><i class="flaticon flaticon-view icon-sm"></i></button>`}#canDisplayActionButton(){var _A=this.#input.get(0);return this.#settings.showActionButton&&_A.nodeName.toLowerCase()==='input'&&!_A.disabled&&parent.ECM.workflowView.userPermissions.indexOf('P')>=0}#changeButtonsState(){var E=this.#attachmentFilename.length!==0;if(this.#canDisplayActionButton())E?(this.#container.find(`.${b}BtnUpuloadFile`).addClass('hide'),this.#container.find(`.${b}BtnDeleteFile`).removeClass('hide')):(this.#container.find(`.${b}BtnDeleteFile`).addClass('hide'),this.#container.find(`.${b}BtnUpuloadFile`).removeClass('hide'));else this.#container.find(`.${b}BtnAction`).addClass('hide');E?this.#container.find(`.${b}BtnViewerFile`).removeClass('hide'):this.#container.find(`.${b}BtnViewerFile`).addClass('hide')}#confirmDeleteAttachment(){FLUIGC.message.confirm({message:`Deseja remover o anexo <b>${this.#attachmentFilename}</b>?`,title:'Confirmação',labelYes:'Sim, quero remover',labelNo:'Não, quero cancelar'},aA=>{if(!aA)return;this.deleteAttachment()})}#uploadAttachment(){let aB=this.#input.data('filename')||this.#settings.filename;if(this.#settings.prefixName===!0)aB=FLUIGC.utilities.randomUUID().substring(0,9)+aB;else (this.#settings.prefixName!==!1&&c(this.#settings.prefixName))&&(aB=`${this.#settings.prefixName}-${aB}`);if(parent.ECM.attachmentTable.getData().findIndex(aC=>aC.description===aB)!==-1){FLUIGC.toast({title:'Atenção',message:'Já existe um anexo com essa descrição',type:'warning'});return}parent.$('#ecm-navigation-inputFile-clone').attr({'data-on-camera':'true','data-file-name-camera':aB,'data-inputid':this.#input.attr('id'),'data-filename':aB,'multiple':!1,'accept':this.#input.data('accept')||this.#settings.accept}).trigger('click')}#viewAttachment(){var aD=parent.ECM.attachmentTable.getData().findIndex(aE=>aE.description===this.#attachmentFilename);if(aD===-1){FLUIGC.toast({title:'Atenção',message:'Anexo não encontrado',type:'warning'});return}var _B=parent.ECM.attachmentTable.getRow(aD);_B.documentId?parent.WKFViewAttachment.openAttachmentView(parent.WCMAPI.userCode,_B.documentId,_B.version):parent.WKFViewAttachment.downloadAttach([aD])}}$.fn[b]=function(aF){if(!parent.WKFViewAttachment||!parent.ECM||!parent.ECM.attachmentTable){console.error(`Plugin ${b} executado fora de um processo.`);return this}if(c(aF)){var aG=aF;if(e.includes(aG)){var _c=$(this.get(0)),_d=_c.data(b);if(!_d||!_d[aG])return;return _d[aG]()}return this.each(function(){var aH=$(this).data(b);aH?.[aG]&&aH[aG]()})}var _e=$.extend({},d,aF);return this.each(function(){!$.data(this,b)&&$.data(this,b,new Plugin(this, _e))})};if(!parent.WKFViewAttachment||!parent.ECM||!parent.ECM.attachmentTable)return;var g=FLUIGC.loading(window,{title:'Aguarde',textMessage:'Enviando arquivo'});$(()=>{$('#tab-attachments',parent.document).hide();parent.$('#ecm_navigation_fileupload').on(`fileuploadadd.${b}`,function(e,aI){var _C=aI.files[0];if(parent.ECM.maxUploadSize>0&&_C.size>=(parent.ECM.maxUploadSize*1024*1024))return;if(parent.ECM.newAttachmentsDocs.length&&parent.ECM.newAttachmentsDocs.findIndex(aJ=>aJ.name===_C.name)!==-1)return;g.show()}).on(`fileuploadfail.${b}`,()=>g.hide()).on(`fileuploaddone.${b}`,function(){g.hide();var aK=parent.document.getElementById('ecm-navigation-inputFile-clone'),aL=aK.getAttribute('data-filename');if(parent.ECM.attachmentTable.getData().findIndex(aM=>aM.description===aL)===-1)return;$(`#${aK.getAttribute('data-inputid')}`).val(aL).trigger('change')});parent.$(document).on(`fileuploadstop.${b}`,()=>g.hide())});$('head').append(`<style>
.${b}Component {
    display: flex;
    align-items: center;
    flex-wrap: nowrap;
}
.${b}Component input {
    border-top-right-radius: 0 !important;
    border-bottom-right-radius: 0 !important;
}
.${b}Component_buttons {
    display: flex;
    align-items: center;
    justify-content: flex-end;
}
.${b}Component_buttons .btn {
    outline: none !important;
    outline-offset: unset !important;
    border-radius: 0 !important;
    height: 32px;
}
</style>`)}(jQuery));
