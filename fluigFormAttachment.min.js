var aQ=a=>a==void 0;;(function($){"use strict";var b='fluigFormAttachment',c=item=>typeof item==='string',d=a=>parent.ECM.attachmentTable.getData().findIndex(A=>A.description===a),e={showActionButton:!0,filename:'Anexo',prefixName:!1,accept:'*'};class Plugin{#settings;#input;#container;#attachmentFilename;constructor(_,B){(!_.id&&_.nodeName.toLowerCase()==='input')&&(_.id=FLUIGC.utilities.randomUUID());this.#settings=$.extend({},e,B);this.#input=$(_);this.#attachmentFilename=this.#input.val()||this.#input.text().trim();this.#input.prop('readonly',!0).on('change',()=>{this.#attachmentFilename=this.#input.val();this.#changeButtonsState()}).wrap(`<div class="${b}Component"></div>`).after(`<div class="${b}Component_buttons">${this.#getButtonsTemplate()}</div>`);this.#container=this.#input.closest(`.${b}Component`);this.#container.on('click',`.${b}BtnDeleteFile`,()=>this.#confirmDeleteAttachment()).on('click',`.${b}BtnUpuloadFile`,()=>this.#uploadAttachment()).on('click',`.${b}BtnViewerFile`,()=>this.#viewAttachment())}isValid(){return this.#attachmentFilename.length?this.hasAttachment():!0}hasAttachment(){var C=this.#attachmentFilename||this.#input.val()||this.#input.text().trim();return C.length>0&&d(C)!==-1}deleteAttachment(){var _a=parent.ECM.attachmentTable.getData().findIndex(D=>D.description===this.#attachmentFilename);setTimeout(()=>this.#input.val('').trigger('change'),500);if(_a===-1)return;parent.WKFViewAttachment.removeAttach([_a])}showActionButton(){this.#settings.showActionButton=!0;this.#input.trigger('change')}hideActionButton(){this.#settings.showActionButton=!1;this.#input.trigger('change')}filename(_A,_b){if(aQ(_A))return this.#input.data('filename')||this.#settings.filename;this.#settings.filename=_A;this.#input.data('filename',_A);!aQ(_b)&&this.prefixName(_b)}prefixName(E){if(aQ(E))return this.#settings.prefixName;this.#settings.prefixName=E}#getButtonsTemplate(){var aA=this.#attachmentFilename.length!==0,_B=this.#canDisplayActionButton();return `<button type="button" class="${b}BtnAction ${b}BtnDeleteFile btn btn-danger btn-sm ${(_B&&aA)?'':'hide'}" title="Remover Anexo"><i class="flaticon flaticon-trash icon-sm"></i></button>`+`<button type="button" class="${b}BtnAction ${b}BtnUpuloadFile btn btn-success btn-sm ${(_B&&!aA)?'':'hide'}" title="Enviar Anexo"><i class="flaticon flaticon-upload icon-sm"></i></button>`+`<button type="button" class="${b}BtnViewerFile btn btn-info btn-sm ${aA?'':'hide'}" title="Visualizar Anexo"><i class="flaticon flaticon-view icon-sm"></i></button>`}#canDisplayActionButton(){var aB=this.#input.get(0);return this.#settings.showActionButton&&parent.ECM.workflowView.userPermissions.indexOf('P')>=0&&location.href.includes('ManagerMode')&&!location.href.includes('token')&&aB.nodeName.toLowerCase()==='input'&&!aB.disabled}#changeButtonsState(){var aC=this.#attachmentFilename.length!==0;if(this.#canDisplayActionButton())aC?(this.#container.find(`.${b}BtnUpuloadFile`).addClass('hide'),this.#container.find(`.${b}BtnDeleteFile`).removeClass('hide')):(this.#container.find(`.${b}BtnDeleteFile`).addClass('hide'),this.#container.find(`.${b}BtnUpuloadFile`).removeClass('hide'));else this.#container.find(`.${b}BtnAction`).addClass('hide');aC?this.#container.find(`.${b}BtnViewerFile`).removeClass('hide'):this.#container.find(`.${b}BtnViewerFile`).addClass('hide')}#confirmDeleteAttachment(){if(!this.#canDisplayActionButton())return;FLUIGC.message.confirm({message:`Deseja remover o anexo <b>${this.#attachmentFilename}</b>?`,title:'Confirmação',labelYes:'Sim, quero remover',labelNo:'Não, quero cancelar'},aD=>{if(!aD)return;this.deleteAttachment()})}#uploadAttachment(){if(!this.#canDisplayActionButton())return;let aE=this.#input.data('filename')||this.#settings.filename;if(this.#settings.prefixName===!0)aE=FLUIGC.utilities.randomUUID().substring(0,9)+aE;else (this.#settings.prefixName!==!1&&c(this.#settings.prefixName))&&(aE=`${this.#settings.prefixName}-${aE}`);if(d(aE)!==-1){FLUIGC.toast({title:'Atenção',message:'Já existe um anexo com essa descrição',type:'warning'});return}parent.$('#ecm-navigation-inputFile-clone').attr({'data-on-camera':'true','data-file-name-camera':aE,'data-inputid':this.#input.attr('id'),'data-filename':aE,'multiple':!1,'accept':this.#input.data('accept')||this.#settings.accept}).trigger('click')}#viewAttachment(){var aF=parent.ECM.attachmentTable.getData().findIndex(aH=>aH.description===this.#attachmentFilename);if(aF===-1){FLUIGC.toast({title:'Atenção',message:'Anexo não encontrado',type:'warning'});return}var aG=parent.ECM.attachmentTable.getRow(aF);aG.documentId?parent.WKFViewAttachment.openAttachmentView(parent.WCMAPI.userCode,aG.documentId,aG.version):parent.WKFViewAttachment.downloadAttach([aF])}}$.fn[b]=function(aI){if(!parent.WKFViewAttachment||!parent.ECM||!parent.ECM.attachmentTable){console.error(`Plugin ${b} executado fora de um processo.`);return this}if(c(aI)){var aJ=aI,_c=Array.prototype.slice.call(arguments,1);let aK;this.each(function(){let aL=$.data(this,b);!aL&&(aL=new Plugin(this, {}),$.data(this,b,aL));if(!aL[aJ])return;aK=aL[aJ](..._c);if(!aQ(aK))return!1});return !aQ(aK)?aK:this}return this.each(function(){!$.data(this,b)&&$.data(this,b,new Plugin(this, aI))})};if(!parent.WKFViewAttachment||!parent.ECM||!parent.ECM.attachmentTable)return;var g=FLUIGC.loading(window,{title:'Aguarde',textMessage:'Enviando arquivo'});$(()=>{$('#tab-attachments',parent.document).hide();parent.$('#ecm_navigation_fileupload').on(`fileuploadadd.${b}`,function(e,aM){var _C=aM.files[0];if(parent.ECM.maxUploadSize>0&&_C.size>=(parent.ECM.maxUploadSize*1024*1024))return;if(parent.ECM.newAttachmentsDocs.length&&parent.ECM.newAttachmentsDocs.findIndex(aN=>aN.name===_C.name)!==-1)return;g.show()}).on(`fileuploadfail.${b}`,()=>g.hide()).on(`fileuploaddone.${b}`,function(){g.hide();var aO=parent.document.getElementById('ecm-navigation-inputFile-clone'),aP=aO.getAttribute('data-filename');if(d(aP)===-1)return;$(`#${aO.getAttribute('data-inputid')}`).val(aP).trigger('change')});parent.$(document).on(`fileuploadstop.${b}`,()=>g.hide())});$('head').append(`<style>.${b}Component { display: flex; align-items: center; flex-wrap: nowrap; } .${b}Component input { border-top-right-radius: 0 !important; border-bottom-right-radius: 0 !important; } .${b}Component_buttons { display: flex; align-items: center; justify-content: flex-end; } .${b}Component_buttons .btn { outline: none !important; outline-offset: unset !important; border-radius: 0 !important; height: 32px; }</style>`)}(jQuery));
