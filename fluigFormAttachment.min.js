;(function($){"use strict";var b='fluigFormAttachment',c=item=>typeof item==='string',d={showActionButton:!0,filename:'Anexo',prefixName:!1},e=['isValid','hasAttachment'];class Plugin{#settings;#input;#container;#attachmentFilename;constructor(a,A){this.#settings=$.extend({},d,A);this.#input=$(a);this.#attachmentFilename=this.#input.val()||this.#input.text().trim();this.#input.prop('readonly',!0).on('change',()=>{this.#attachmentFilename=this.#input.val();this.#changeButtonsState()}).wrap(`<div class="${b}Component"></div>`).after(`<div class="${b}Component_buttons">${this.#getButtonsTemplate()}</div>`);this.#container=this.#input.closest(`.${b}Component`);this.#container.on('click',`.${b}BtnDeleteFile`,()=>this.#confirmDeleteAttachment()).on('click',`.${b}BtnUpuloadFile`,()=>this.#uploadAttachment()).on('click',`.${b}BtnViewerFile`,()=>this.#viewAttachment())}isValid(){return this.#attachmentFilename.length?this.hasAttachment():!0}hasAttachment(){return this.#attachmentFilename.length>0&&parent.ECM.attachmentTable.getData().findIndex(_=>_.description===this.#attachmentFilename)!==-1}deleteAttachment(){var B=parent.ECM.attachmentTable.getData().findIndex(C=>C.description===this.#attachmentFilename);setTimeout(()=>this.#input.val('').trigger('change'),500);if(B===-1)return;parent.WKFViewAttachment.removeAttach([B])}#getButtonsTemplate(){var _a=this.#attachmentFilename.length!==0,_b=this.#input.get(0);let _c='';(this.#settings.showActionButton&&_b.nodeName.toLowerCase()==='input'&&!_b.disabled)&&(_c+=_a?`<button type="button" class="${b}BtnAction ${b}BtnDeleteFile btn btn-danger btn-sm" title="Remover Anexo"><i class="flaticon flaticon-trash icon-sm"></i></button>`:`<button type="button" class="${b}BtnAction ${b}BtnUpuloadFile btn btn-success btn-sm" title="Enviar Anexo"><i class="flaticon flaticon-upload icon-sm"></i></button>`);_c+=`<button type="button" class="${b}BtnViewerFile btn btn-info btn-sm" ${_a?'':'style="display:none"'} title="Visualizar Anexo"><i class="flaticon flaticon-view icon-sm"></i></button>`;return _c}#changeButtonsState(){var D=this.#attachmentFilename.length!==0;if(this.#settings.showActionButton){var _B=[];let _A='';let E='';D?(_B.push(`${b}BtnDeleteFile`),_B.push('btn-danger'),_A='flaticon-trash',E='Remover Anexo'):(_B.push(`${b}BtnUpuloadFile`),_B.push('btn-success'),_A='flaticon-upload',E='Enviar Anexo');this.#container.find(`.${b}BtnAction`).removeClass([`${b}BtnUpuloadFile`,`${b}BtnDeleteFile`,'btn-danger','btn-success']).addClass(_B).attr('title',E).trigger('blur').find('i').removeClass(['flaticon-trash','flaticon-upload']).addClass(_A)}D?this.#container.find(`.${b}BtnViewerFile`).show():this.#container.find(`.${b}BtnViewerFile`).hide()}#confirmDeleteAttachment(){FLUIGC.message.confirm({message:`Deseja remover o anexo <b>${this.#attachmentFilename}</b>?`,title:'Confirmação',labelYes:'Sim, quero remover',labelNo:'Não, quero cancelar'},aA=>{if(!aA)return;this.deleteAttachment()})}#uploadAttachment(){let aB=this.#input.data('filename')||this.#settings.filename;if(this.#settings.prefixName===!0)aB=FLUIGC.utilities.randomUUID().substring(0,9)+aB;else (this.#settings.prefixName!==!1&&c(this.#settings.prefixName))&&(aB=`${this.#settings.prefixName}-${aB}`);if(parent.ECM.attachmentTable.getData().findIndex(aD=>aD.description===aB)!==-1){FLUIGC.toast({title:'Atenção',message:'Já existe um anexo com esse nome',type:'warning'});return}var aC=$('#ecm-navigation-inputFile-clone',parent.document).attr({'data-on-camera':'true','data-file-name-camera':aB,'multiple':!1}).trigger('click');aC.on(`change.${b}`,aE=>{aC.off(`change.${b}`);var aF=aE.target.files[0];if(parent.ECM.maxUploadSize>0&&aF.size>parent.ECM.maxUploadSize*1024*1024)return;if(!parent.ECM.workflowView.processInstanceId){var _C=parent.ECM.attachmentTable.getData().findIndex(aG=>aG.name===aF.name);if(_C!==-1)return}setTimeout(()=>this.#input.val(aB).trigger('change'),500)})}#viewAttachment(){var aH=parent.ECM.attachmentTable.getData().findIndex(aJ=>aJ.description===this.#attachmentFilename);if(aH===-1){FLUIGC.toast({title:'Atenção',message:'Anexo não encontrado',type:'warning'});return}var aI=parent.ECM.attachmentTable.getRow(aH);aI.documentId?parent.WKFViewAttachment.openAttachmentView(parent.WCMAPI.userCode,aI.documentId,aI.version):parent.WKFViewAttachment.downloadAttach([aH])}}$.fn[b]=function(aK){if(!parent.WKFViewAttachment||!parent.ECM||!parent.ECM.attachmentTable){console.error(`Plugin ${b} executado fora de um processo.`);return this}if(c(aK)){var aL=aK;if(e.includes(aL)){var aM=$(this.get(0)),_d=aM.data(b);if(!_d||!_d[aL])return;return _d[aL]()}return this.each(function(){var aN=$(this).data(b);aN?.[aL]&&aN[aL]()})}var _e=$.extend({},d,aK);return this.each(function(){!$.data(this,b)&&$.data(this,b,new Plugin(this, _e))})};if(!parent.WKFViewAttachment||!parent.ECM||!parent.ECM.attachmentTable)return;$(()=>$('#tab-attachments',parent.document).hide());$('head').append(`<style>
.${b}Component {
    display: flex;
    align-items: center;
    flex-wrap: nowrap;
}
.${b}Component input {
    border-top-right-radius: 0 !important;
    border-bottom-right-radius: 0 !important;
}
.${b}Component_buttons {
    display: flex;
    align-items: center;
    justify-content: flex-end;
}
.${b}Component_buttons .btn {
    outline: none !important;
    outline-offset: unset !important;
    border-radius: 0 !important;
    height: 32px;
}
</style>`)}(jQuery));
